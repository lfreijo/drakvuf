# Exploitmon Plugin

## Overview

The exploitmon plugin is a DRAKVUF plugin designed to detect various kernel exploitation techniques on Windows systems. It monitors for common privilege escalation and kernel exploitation patterns by tracking process tokens, monitoring kernel memory structures, and detecting suspicious execution patterns.

The plugin implements detection for the following exploitation techniques:

1. **Token Modification Detection** - Tracks process tokens at creation time and compares them at termination to detect token stealing/swapping attacks commonly used for privilege escalation.

2. **HalDispatchTable Overwrite Detection** - Monitors the HalDispatchTable kernel structure for unauthorized modifications, a common technique used in kernel exploits.

3. **Kernel Thread User Memory Execution** - Detects when kernel threads attempt to execute code in user-mode memory pages (requires `enable_k2u` option).

4. **PreviousMode Manipulation** - Detects when usermode calls are made with a privileged PreviousMode value, indicating potential exploitation of the KTHREAD PreviousMode field (x64 only).

5. **SYSTEM Token Process Creation** - Alerts when new processes are created with SYSTEM privileges.

## Supported Operating Systems

- **Windows**: Fully supported (both 32-bit and 64-bit)
- **Linux**: Not supported

The plugin relies on Windows-specific kernel structures including `_EPROCESS`, `_KTHREAD`, `_KTRAP_FRAME`, `_TOKEN`, and the HalDispatchTable.

## Configuration Options

The plugin accepts the following configuration:

| Option | Type | Description |
|--------|------|-------------|
| `enable_k2u` | boolean | Enable kernel-to-usermode execution detection. When enabled, the plugin hooks `MmAccessFault` to detect kernel threads executing user memory. **Note:** This option degrades performance and should only be enabled when specifically needed. |

## How to Enable the Plugin

The plugin is enabled by default in the meson build system. To explicitly control it:

### Enable (default)
```bash
meson setup build -Dplugin-exploitmon=true
```

### Disable
```bash
meson setup build -Dplugin-exploitmon=false
```

## Output Format

The plugin outputs events using DRAKVUF's standard output format (JSON, CSV, or key-value depending on configuration). Each event includes standard DRAKVUF fields plus plugin-specific fields.

### Standard Fields (from drakvuf_trap_info_t)

When trap info is available, the output includes:

| Field | Description |
|-------|-------------|
| TimeStamp | Event timestamp (seconds and microseconds) |
| PID | Process ID |
| PPID | Parent Process ID |
| TID | Thread ID |
| UserId | User ID associated with the process |
| ProcessName | Name of the process |

### Plugin-Specific Fields

| Field | Description |
|-------|-------------|
| Reason | Description of the detected suspicious activity |

### Possible Reason Values

| Reason | Description |
|--------|-------------|
| `Token modification detected` | Process token changed between creation and termination, indicating potential token stealing |
| `HalDispatchTable overwrite detected` | Write access to HalDispatchTable memory region detected |
| `Kernel thread execution` | Kernel thread attempted to execute code in user-mode memory |
| `Usermode call with privileged PreviousMode value` | Syscall from usermode with KTHREAD.PreviousMode set to KernelMode |
| `Process with SYSTEM privileges started` | New process created with SYSTEM token |

## Example Output

### JSON Format

Token modification detection:
```json
{
  "TimeStamp": "1234567890.123456",
  "PID": 1234,
  "PPID": 456,
  "TID": 1235,
  "UserId": 0,
  "ProcessName": "malicious.exe",
  "Plugin": "exploitmon",
  "Reason": "Token modification detected"
}
```

SYSTEM privilege process creation:
```json
{
  "TimeStamp": "1234567890.123456",
  "PID": 5678,
  "PPID": 1234,
  "TID": 5679,
  "UserId": 0,
  "ProcessName": "elevated.exe",
  "Plugin": "exploitmon",
  "Reason": "Process with SYSTEM privileges started"
}
```

HalDispatchTable overwrite:
```json
{
  "TimeStamp": "1234567890.123456",
  "PID": 1234,
  "PPID": 456,
  "TID": 1235,
  "UserId": 0,
  "ProcessName": "exploit.exe",
  "Plugin": "exploitmon",
  "Reason": "HalDispatchTable overwrite detected"
}
```

PreviousMode manipulation (x64 only):
```json
{
  "TimeStamp": "1234567890.123456",
  "PID": 1234,
  "PPID": 456,
  "TID": 1235,
  "UserId": 0,
  "ProcessName": "exploit.exe",
  "Plugin": "exploitmon",
  "Reason": "Usermode call with privileged PreviousMode value"
}
```

Kernel thread user memory execution (requires `enable_k2u`):
```json
{
  "TimeStamp": "1234567890.123456",
  "PID": 4,
  "PPID": 0,
  "TID": 128,
  "UserId": 0,
  "ProcessName": "System",
  "Plugin": "exploitmon",
  "Reason": "Kernel thread execution"
}
```

## Implementation Details

### Hooked Functions

The plugin sets up hooks on the following Windows kernel functions:

- `NtTerminateProcess` - To detect token changes at process termination
- `PspInsertProcess` - To record initial process tokens at creation
- `PspInsertThread` - To detect SYSTEM privilege process creation
- `MmAccessFault` - To detect kernel thread user memory execution (when `enable_k2u` is enabled)
- `NtOpenProcess` - For PreviousMode validation (x64 only)
- `NtLoadDriver` - For PreviousMode validation (x64 only)
- `NtUnloadDriver` - For PreviousMode validation (x64 only)

### Memory Access Monitoring

The plugin also sets up memory access monitoring on:

- **HalDispatchTable** - Write access monitoring to detect overwrite attempts

### Final Analysis

When the plugin stops, it performs a final comparison of all live process tokens against their initial values to catch any token modifications that may have occurred without process termination.
